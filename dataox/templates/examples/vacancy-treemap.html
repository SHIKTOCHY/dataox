{% extends "base.html" %}

{% block title %}Vacancy Treemap{% endblock %}

{% block extra_head %}
  <script src="http://code.jquery.com/jquery-1.5.min.js" type="text/javascript"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script type="text/javascript">
    var endpointURL = 'http://data.ox.ac.uk/sparql/';

	var query = "SELECT ?unit (SAMPLE(?unitLabel_) as ?unitLabel) (count(?vacancy) as ?vacancies) ?parent (SAMPLE(?parentLabel_) as ?parentLabel) ?ancestor (SAMPLE(?ancestorLabel_) as ?ancestorLabel) WHERE {\n"
              + "  GRAPH <http://data.ox.ac.uk/graph/vacancies/current> {\n" 
              + "    ?vacancy a vacancy:Vacancy ;\n"
              + "      vacancy:organizationalUnit ?unit ;\n"
              + "      vacancy:applicationClosingDate ?closes .\n"
              + "    FILTER (?closes > now()) .\n"
              + "  } .\n"
              + "  ?unit skos:prefLabel ?unitLabel_ .\n"
              + "  OPTIONAL { ?unit org:subOrganizationOf* ?parent . ?parent skos:prefLabel ?parentLabel_ ."
              + "             OPTIONAL {?parent org:subOrganizationOf ?ancestor . ?ancestor skos:prefLabel ?ancestorLabel_ } }\n"
              + "} GROUP BY ?unit ?parent ?ancestor ORDER BY ?unit ?parent\n";


	var vacancyQuery = "SELECT ?vacancy (SAMPLE(?label_) as ?label) (SAMPLE(?description_) as ?description) (SAMPLE(?closing_) as ?closing) (SAMPLE(?salary_) as ?salary) (SAMPLE(?homepage_) as ?homepage) WHERE {\n"
	                 + "  ?vacancy vacancy:organizationalUnit <UNIT> ;\n"
                     + "    rdfs:label ?label_ .\n"
                     + "  OPTIONAL {?vacancy rdfs:comment ?description_ . FILTER ( datatype(?description_) != xtypes:Fragment-XHTML ) }\n"
                     + "  OPTIONAL {?vacancy vacancy:applicationClosingDate ?closing_ . }\n"
                     + "  OPTIONAL {?vacancy vacancy:salary/rdfs:label ?salary_ . }\n"
                     + "  OPTIONAL {?vacancy foaf:homepage ?homepage_ . }\n"
                     + "} GROUP BY ?vacancy ORDER BY ASC(?closing)\n";

    google.load("visualization", "1", {packages:["treemap"]});
  
    $(function() {
	 
	    window.vacancyData = new google.visualization.DataTable();
        window.vacancyData.addColumn('string', 'Unit');
        window.vacancyData.addColumn('string', 'Parent');
        window.vacancyData.addColumn('number', 'Number of Vacancies');
	    window.vacancyData.addColumn('number', 'Colour');
	  
	    window.unitLookup = {};

        // Create and populate the data table.
        $.get(endpointURL, {
            'format': 'srj',
            'query': query,
            'common_prefixes': 'on'
        }, function (data) {
            window.vacancyTreeMap = new google.visualization.TreeMap(document.getElementById('visualization'));
          
            var vacancyData = {}, withChildren = {}, missingParents = 0;
            for (var i in data.results.bindings) {
                var binding = data.results.bindings[i];
                if (binding.ancestor == undefined) {
                    binding.ancestor = { "value": null };
                    binding.ancestorLabel = { "value": null };
                    if (vacancyData[binding.parent.value] == undefined)
                        missingParents += 1;
                }              
                vacancyData[binding.parent.value] = {
                    "self": binding.parent.value,
                    "label": binding.parentLabel.value,
                    "parent": binding.ancestor.value,
                    "parentLabel": binding.ancestorLabel.value,
                    "vacancies": 0
                };
                withChildren[binding.ancestor.value] = true;
            }
            if (missingParents > 1) {
                for (var uri in vacancyData) {
                    var datum = vacancyData[uri];
                    if (datum.parent == null) {
                        datum.parent = "Oxford";
                        datum.parentLabel = "Oxford";
                    }
                }
                vacancyData["Oxford"] = {
                    "self": "Oxford",
                    "label": "Oxford",
                    "parent": null,
                    "parentLabel": null,
                    "vacancies": 0
                };
            }
            for (var i in data.results.bindings) {
                var binding = data.results.bindings[i];
                if (withChildren[binding.unit.value]) {
                    vacancyData[binding.unit.value + "+"] = {
                        "self": binding.unit.value + "+",
                        "label": binding.unitLabel.value + " (itself)",
                        "parent": binding.unit.value,
                        "parentLabel": binding.unitLabel.value,
                        "vacancies": parseInt(binding.vacancies.value)
                    };
                } else {
                    vacancyData[binding.unit.value].vacancies = parseInt(binding.vacancies.value);
                }
            }
            for (var uri in vacancyData) {
                var datum = vacancyData[uri];
                var label = datum.label.replace(/^(Department|Faculty) (of|for)/, "");
                var parentLabel = datum.parentLabel ? datum.parentLabel.replace(/^(Department|Faculty) (of|for)/, "") : null;
                window.vacancyData.addRow([label, parentLabel, datum.vacancies, 0]);
                window.unitLookup[label] = uri.replace("+", "");
            }
		    
            var nocolours = 0;
		    for (i = 0; i < window.vacancyData.getNumberOfRows(); i = i + 1) {
                var dept = window.vacancyData.getValue(i, 0);
                var parent = window.vacancyData.getValue(i, 1);
                if (parent == "University of Oxford" || (parent=="Oxford" && dept != "University of Oxford"))
                    nocolours += 1;
		    }
		
		    var coloursadded = 1;
		    for (i = 0; i < window.vacancyData.getNumberOfRows(); i++) {
		        var dept = window.vacancyData.getValue(i, 0);
		        var parent = window.vacancyData.getValue(i, 1);
                if (parent == "University of Oxford" || (parent=="Oxford" && dept != "University of Oxford")) {
                    window.vacancyData.setCell(i, 3, (coloursadded));
                    setChildren(dept, coloursadded);
                    coloursadded += 1;
                }
            }
		
            function setChildren(dept, coloursadded) {
                var j = 0;
                for (j = 0; j < window.vacancyData.getNumberOfRows(); j++) {
                    var new_dept = window.vacancyData.getValue(j, 0);
                    var new_parent = window.vacancyData.getValue(j, 1);
                    if (new_parent == dept) {
                        window.vacancyData.setCell(j, 3, coloursadded);
                        setChildren(new_dept, coloursadded);
                    }
                }
            }
            
            window.vacancyTreeMap.draw(window.vacancyData, {
                minColor: 'd4c665',
                midColor: 'eeeeee',
                maxColor: '6d6fc3',
	    		maxDepth: 5,
                headerHeight: 25,
                fontColor: 'black',
                showScale: false});
		    google.visualization.events.addListener(window.vacancyTreeMap, 'select', showVacancyList);
        }, 'json');
    });
    

    function showVacancyList(e) {
        var unitLabel = window.vacancyData.getValue(window.vacancyTreeMap.getSelection()[0].row, 0);
        var unit = window.unitLookup[unitLabel];
        
        $.get(endpointURL, {
            'format': 'srj',
            'query': vacancyQuery.replace("UNIT", unit),
            'common_prefixes': 'on'
        }, function (data) {
            var vacancyTable = $('#vacancyTable');
            var body = vacancyTable.find("tbody").empty();
            vacancyTable.find("thead tr").html("<th>Title</th><th>Description</th><th>Salary</th><th>Closes</th>");
            vacancyTable.children("caption").remove();
            vacancyTable.prepend($('<caption/>').text("Current vacancies within " + unitLabel));
            for (var i in data.results.bindings) {
                var vacancy = data.results.bindings[i];
                var description = vacancy.description ? vacancy.description.value : "";
                if (description.length > 200) description = description.substr(0, 200) + "â€¦";
                var row = $("<tr/>").append($("<td/>").append($("<a/>").attr("href", vacancy.vacancy.value).text(vacancy.label.value)))
                                    .append($("<td/>").html(description.replace("\n", "<br/>")))
                                    .append($("<td/>").text(vacancy.salary.value))
                                    .append($("<td/>").text(vacancy.closing.value))
                                    .attr("class", i % 2 ? "row-even" : "row-odd");
                body.append(row);
            }
        }, "json");
    }
  </script>
  <style type="text/css">
   p#description {
      margin-top:0;
      font-size: 10pt;
    }
    h1 {
      margin-bottom: 0;
    }
    
    #loading {
      padding:4em;
      margin:4em;
      text-align:center;
      font-size:30px;
	}
    
  </style>
{% endblock %}

{% block content %}
    <h1>Vacancy Treemap</h1>
       
    <div id="visualization" style="width: 930px; height: 600px; margin-top:5px;"></div>
		<div id="jobs" style="padding:10px">
			<table class="sparql-results" id="vacancyTable" style="width:100%">
				<thead>
				  <tr>
				    <th>Please click on an individual department to view the vacancies within it.</th>
				  </tr>
				</thead>
				<tbody></tbody>
			</table>
		</div>

    <section id="details" style="clear:both; padding:1em; margin-top:1em">
		<h2>Details</h2> 
      <p>This shows a breakdown (by department) of the vacancies currently available on the University of Oxford's <a href="http://www.recruit.ox.ac.uk">recruitment website</a> and/or <a href="http://www.jobs.ac.uk">www.jobs.ac.uk</a>.</p>
	  <p>Left-click on a department to see the breakdown of vacancies within that department if it has any subdepartments. Right-click to move to its parent department.</p>
	  <p>The Treemap is powered by the <a href="http://code.google.com/apis/chart/">Google Chart Tools</a>.</p>
	  <p>Note: some RSS feeders (eg Outlook) convert URLs to lowercase before subscribing, yet URLs are case sensitive. In this situation, please use a service such as <a href="http://bit.ly">http://bit.ly</a> to change one of our links to a lower-case URL.</p>
    </section>
{% endblock %}
